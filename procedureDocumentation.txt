
----------------------------- Gene Family - Presence/Absence Matrix-----------------------------------

1) Downloading the GBFF Files from NCBI - Assembly
This time, we need the genbank files in order to extract accession numbers and protein IDs 
from each.

2) Extract Protein Sequences - modified_get_features.pl
This extracts the protein sequences from the genbank files

	mkdir targetdirectory
        cd path/to/targetdirectory
	for x in *.gbff; 
        do 
            modified_get_features.pl -t $x > `basename $x`'.faa' 2>> errorfile.txt; 
        done

The errorfile.txt is technically not necessary, but can be a good reference later all for 
possible pseudogenes. The t flag for modifed_get_features.pl makes the head of
each sequence ters (only accnum:protID), see the file for more documentation.

3) Make a blast database
First, concatenate all the .faas into one file.
	
	cat *.faa > {# of files}{bacteria_name}.faa

Using vim, remove all spaces and commas from the sequence IDs so that BLAST will be able to 
recognize the format. NOTE: you might want to keep the original file with the spaces in it, 
as it may help with some regex in the latter parts, though I have written mine without the 
need for it.
Afterwards, the blast database can be made using:

	makeblastdb -in {#}{bacteria_name}.faa -out {bacteria_name}DB -dbtype 
	prot -parse_seqids 

4) Run the reciprocal blastp 

	blastp  -db {bacteria_name}DB 
                -query {#}{bacteria_name}.faa 
                -out allvsall_wotransposase_softmask_sw 
                -evalue 5e-2 
                -outfmt '7 qseqid qlen qstart qend length sseqid slen qcovs score bitscore evalue' 
                -soft_masking true 
                -use_sw_tback
                 & (this is to make it run in the background)

Note: The num_threads argument was purposely left out due to segmentation faults and
abrupt abortions on info113, info114 and info115. As a result, this was omitted entirely. 
Alternative methods could be attempting to use a lesser number of cores or splitting up the
large *.faa file and manually running them in parallel.

5) Weeding Out blastp results - extract85.R

We only want certain hits, hence all hits which match length less than 85% of the query length
 or are hits to the same gene are removed from the blastp file. extract85.R does this by 
importing the file as a table and checks the relevant columns.

***FIRST, remove all quotes from the file ('). For some reason the R code does not respond well
 to quotations.

By running,
	
	Rscript extract85.R allvsall_wotransposase_softmask_sw 

The files outputwolessthan85.txt and outputwohitstosamegene.txt are produced. Technically, the
former file seems to only exist as a transition file, and can probably be automatically in 
future reversions of the code/pipeline.

6) Editing input for "genefamily11.R"
genefamily11.R requires the input file to be labelled "output.txt", and is an adjusted version 
of "outputwohitstothesamegene.txt". This can be done with Athena's code: qspandsubspecies.pl 
The format requires for the long winded sequence IDs to be removed and replaced with only the 
relevant accession number and protein ID for columns 1 and 7(?). 

I personally used vim regex to complete the task although you can do it any which way you wish
. Making sure the pattern correlates, use the vim regex:

	:%s/[A-Z]\{2}\d\{6}\zs.\{-}\ze[A-Z]\{3}\d\{5}\.\d/\t/g

NOTE: Your patterns may vary, so make sure to check and verify.

7) Forming Gene Families - genefamily11.R
	
	R --vanilla <genefamily11.R> genefamily11.out 	

This step also requires the file called "listofallgenes.txt", which is a file consisting of
 accession number and their associated protein IDs in two separate columns. This file can be 
obtained by running "ascension_protid.py" on the original gbff files, which uses regex to extract 
the relavant information into the desired format.

	for x in *.gbff; do ascension_protid.py $x; done >> listofallgenes.txt 

This is where the gene families are finally formed and generated. The code runs and determines
gene family by identifying genes which have reciprocal blast hits on each other. Note that
if gene A hits gene B, and gene B hits gene C, then A, B and C are a family.

Genes which have no hits are printed into genesforNR.txt and the image containing the lists 
of lists of genes (i.e. the gene families) are saved into the session image "gfcode1.Rdata"

8) Verifying Singleton Genes
In order to verify that the single genes (i.e. gene families of one) are actually significant 
and a "valid" gene, the list of proteins from  geneforNR.txt are rerun through blastp against
the NR database.

	-Using vim, yank solely the protein IDs out from the generated list (this should be
	 easily done using CTRL+V, or regex if you are comfortable with that). Write that to
	 separate text file.
	-Run matchingprotid.py. This function receives two arguments: the first being the 
	concatenated file generated from modified_get_features.pl (spaces shouldn't matter
	but personally I did mine without spaces), and the second argument is the text file
	that was just generated

	matchingprotid.py seeks to pull out sequence ONLY if it contains the relevant protein
	ID

Transfer the new list of sequences to the scratch disk and run a blastp on it against 
the nr databases:

	blastp -db /1/scratch/blastdb/nr -query proteinseqlist.txt -out [OUTPUT NAME] -evalue
	0.05 -parse_deflines -outfmt '7 seqid qlen qstart qend length sseqid slen qcovs score
	bitscore evalue stitle sallseqid salltitles' -soft_masking true -use_sw_tback &


